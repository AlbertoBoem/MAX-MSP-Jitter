import("stdfaust.lib");

toneBar = shoeModelWood2(freq,exPos,t60,t60DecayRatio,t60DecaySlope)
with{
  freq = hslider("freq",30,0,2000,0.001) : si.smoo; 
  exPos = 0;
  t60 = 0.1;
  t60DecayRatio = 1;
  t60DecaySlope = 10; 
};

excitation = button("gate");

process = excitation : toneBar <: _,_;

shoeModelWood2(freq,exPos,t60,t60DecayRatio,t60DecaySlope) = _ <: par(i,nModes,pm.modeFilter(modesFreqs(i),modesT60s(i),modesGains(int(exPos),i))) :> /(nModes)
with{
nModes = 16;
nExPos = 6;
modesFreqRatios(n) = ba.take(n+1,(1,4.05021,5.19577,54.7049,70.5378,79.6912,109.772,138.629,148.258,184.989,190.729,197.993,212.524,242.266,248.401,267.555));
modesFreqs(i) = freq*modesFreqRatios(i);
modesGains(p,n) = waveform{0.864371,0.811921,0.546358,0.835779,0.301298,0.912211,0.39228,0.588269,1,0.468883,0.710527,0.0947995,0.218166,0.650953,0.285504,0.566895,0.85948,0.821262,0.550286,0.831646,0.306461,0.906766,0.390647,0.586301,1,0.488317,0.715421,0.100648,0.222597,0.668707,0.280753,0.554906,0.860244,0.804548,0.516644,0.788974,0.186418,0.92187,0.264339,0.471169,1,0.481612,0.764881,0.0609693,0.184756,0.660169,0.48408,0.518049,0.0509621,0.0342349,0.356872,0.677311,0.239641,0.54473,0.738142,0.468801,0.524157,1,0.208797,0.680099,0.361712,0.557888,0.434166,0.648483,0.0612673,0.0399531,0.337207,0.669817,0.199791,0.569086,0.737891,0.542336,0.553028,1,0.212873,0.79022,0.227907,0.557996,0.419178,0.679834,0.0519491,0.0371123,0.368513,0.69304,0.247865,0.560802,0.755138,0.483406,0.536656,1,0.265255,0.701053,0.392923,0.57971,0.448035,0.661895},int(p*nModes+n) : rdtable : select2(modesFreqs(n)<(ma.SR/2-1),0);
modesT60s(i) = t60*pow(1-(modesFreqRatios(i)/292.983)*t60DecayRatio,t60DecaySlope);
};
